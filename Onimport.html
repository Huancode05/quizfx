<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>é¢˜åº“è‡ªæµ‹-è‡ªè¡Œå¯¼å…¥</title>

<style>
:root{
  --bg:#f5f7fb;--card:#ffffff;--text:#0f172a;
  --primary:#4f46e5;--ok:#16a34a;--bad:#dc2626;
  --muted:#64748b;--border:#e2e8f0;
}
body.dark{
  --bg:#0b1220;--card:#111827;--text:#e5e7eb;
  --muted:#94a3b8;--border:#1f2937;
}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
}
.container{max-width:980px;margin:auto;padding:16px}
.card{
  background:var(--card);border-radius:20px;padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.08)
}
.hidden{display:none}

/* å¯¼å…¥åŒº */
.drag{
  border:2px dashed var(--muted);
  border-radius:16px;
  padding:16px;
  text-align:center;
  margin-bottom:16px;
}

/* Header */
.header{
  display:flex;justify-content:space-between;align-items:center;
}
.header-left{
  display:flex;align-items:center;gap:12px;
}
.stats{font-weight:600}
#fileName{font-weight:600;color:var(--muted);}

/* èœå• */
.menu{position:relative}
.menu-btn{
  background:none;
  font-size:22px;
  color:var(--text);
  border: none;
  cursor: pointer;
  padding: 4px 8px;
}
.menu-list{
  position:absolute;
  right:0; top:38px;
  background:var(--card);
  border-radius:14px;
  box-shadow:0 15px 35px rgba(0,0,0,.25);
  padding:8px;
  min-width:200px;
  opacity:0; transform:scale(.95);
  pointer-events:none; transition:.18s ease;
  display:flex;
  flex-direction:column;
  gap:6px;
  z-index: 10;
}
.menu-list.show{
  opacity:1; transform:scale(1); pointer-events:auto;
}
.menu-list a,
.menu-list button,
.menu-list label{
  width:100%;
  text-align:left;
  background:none;
  padding:10px 12px;
  border-radius:10px;
  color:var(--text);
  border: none;
  font-size: 16px;
  cursor: pointer;
}
.menu-list a:hover,
.menu-list button:hover{
  background:rgba(79,70,229,.1);
}

/* é¢˜ç›® & å›¾ç‰‡å®¹å™¨æ ·å¼ */
.question{
  margin-top:18px;
  font-size:22px;
  font-weight:600;
  line-height:1.65;
}
/* å›¾ç‰‡å®¹å™¨æ ¸å¿ƒæ ·å¼ */
.img-container{
  margin: 12px 0;
  width: 100%;
}
.img-toggle-btn{
  background: rgba(79,70,229,.1);
  color: var(--primary);
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  font-size: 16px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
body.dark .img-toggle-btn{
  background: rgba(79,70,229,.2);
}
.img-toggle-btn:hover{
  background: rgba(79,70,229,.2);
}
body.dark .img-toggle-btn:hover{
  background: rgba(79,70,229,.3);
}
/* å›¾ç‰‡å“åº”å¼æ ·å¼ï¼Œé˜²æ­¢æº¢å‡º */
.question-img{
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  margin-top: 8px;
  border: 1px solid var(--border);
}

.options{
  margin-top:16px;
  display:flex;flex-direction:column;gap:12px
}
.option{
  padding:14px 16px;
  border-radius:14px;
  border:1px solid var(--border);
  font-size:18px;
  cursor:pointer
}
.option.correct{
  border-left:6px solid var(--ok);
  background:rgba(22,163,74,.08)
}
body.dark .option.correct{
  background:rgba(22,163,74,.12)
}
.option.wrong{
  border-left:6px solid var(--bad);
  background:rgba(220,38,38,.08)
}

/* Footer */
.footer{
  display:flex;justify-content:space-between;margin-top:22px
}
button{
  min-height:44px;
  border:none;border-radius:14px;
  padding:8px 16px;
  background:var(--primary);color:#fff;
  cursor: pointer;
}
button.secondary{background:#64748b}

@media(max-width:640px){
  .question{font-size:20px}
  .option{font-size:17px}
  .img-toggle-btn{font-size:14px}
}
</style>
</head>
<body>
<div class="container">
<!-- ç™»å½•å¼¹å±‚ï¼ˆæ–°å¢ï¼‰ -->
<div id="loginMask" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center;
  z-index:999;
">
  <div style="
    background:var(--card);
    padding:24px;
    border-radius:16px;
    width:300px;
    box-shadow:0 20px 40px rgba(0,0,0,.3);
  ">
    <h3 style="margin-top:0">ğŸ‘¤ ç”¨æˆ·ç™»å½•</h3>

    <input id="loginName" placeholder="ç”¨æˆ·å"
      style="width:100%;padding:10px;margin:6px 0"/>

    <input id="loginPass" placeholder="å£ä»¤ï¼ˆéšä¾¿å¡«ï¼‰"
      type="password"
      style="width:100%;padding:10px;margin:6px 0"/>

    <button onclick="doLogin()" style="width:100%;margin-top:10px">
      ç™»å½• / è¿›å…¥
    </button>
  </div>
</div>
<!-- é¢˜åº“å¯¼å…¥åŒº -->
<div class="drag" id="loader">
  ğŸ“ æ‹–æ‹½ TXT é¢˜åº“ï¼ˆJSON å†…å®¹ï¼‰<br><br>
  <button onclick="fileInput.click()">ç‚¹å‡»ä¸Šä¼ </button>
  <input type="file" id="fileInput" accept=".txt" hidden>
</div>

<div class="card">
  <div class="header">
    <div class="header-left">
      <span id="fileName">æœªåŠ è½½æ–‡ä»¶</span>
      <div class="stats" id="stats">æœªåŠ è½½é¢˜åº“</div>
      <span id="userStatus" style="font-size:13px;color:var(--muted)"></span>
      <span id="syncStatus" style="font-size:13px;color:var(--muted)"></span>
    </div>

    <div class="menu">
      <button class="menu-btn" onclick="toggleMenu(event)">â‹®</button>
      <div class="menu-list" id="menuList">
  <a href="index.html">ğŸ  è¿”å›é¦–é¡µ</a>
  <button onclick="togglePreview()">ğŸ‘€ å…¨å±€é¢„è§ˆ</button>
  <button onclick="exportReview()">ğŸ’¾ å¯¼å‡ºå¤ä¹ åŒ…</button>
  <button onclick="importReview()">ğŸ“¥ å¯¼å…¥å¤ä¹ åŒ…</button>
  <label><input type="checkbox" id="autoNext" checked> ç­”å¯¹è‡ªåŠ¨ä¸‹ä¸€é¢˜</label>
  <label><input type="checkbox" id="darkMode"> å¤œé—´æ¨¡å¼</label>
  <button onclick="toggleLoader()">ğŸ“ é¢˜åº“å¯¼å…¥</button>
  <button onclick="toggleWrong()">âŒ é”™é¢˜æ¨¡å¼</button>
  <button onclick="logout()">ğŸ”„ åˆ‡æ¢ç”¨æˆ·</button>
  
 <!-- æ–°å¢è·³è½¬åŠŸèƒ½ -->
<div style="margin-top:6px; display:flex; gap:6px; align-items:center;">
  <input type="number" id="jumpInputMenu" min="1" placeholder="é¢˜å·" style="width:60px; padding:2px;"/>
  <button onclick="jumpToMenu()">è·³è½¬</button>
</div>
<button onclick="showProgressList()">ğŸ“š æˆ‘çš„è¿›åº¦</button>
</div>
    </div>
  </div>

  <div id="content"></div>

  <div class="footer">
    <button class="secondary" onclick="prev()">ä¸Šä¸€é¢˜</button>
    <button onclick="next()">ä¸‹ä¸€é¢˜</button>
  </div>
</div>

</div>

<!-- å¤ä¹ åŒ…å¯¼å…¥ä¸“ç”¨ -->
<input type="file" id="reviewInput" accept=".txt" hidden>

<!-- æˆ‘çš„è¿›åº¦åˆ—è¡¨ -->
<div id="progressMask" style="
  position:fixed; inset:0;
  background:rgba(0,0,0,.45);
  display:none; align-items:center; justify-content:center;
  z-index:999;
">
  <div style="
    background:var(--card);
    padding:20px;
    border-radius:16px;
    width:320px;
    max-height:70vh;
    overflow:auto;
  ">
    <h3 style="margin-top:0">ğŸ“š æˆ‘çš„è¿›åº¦</h3>
    <div id="progressList" style="font-size:14px;color:var(--text)"></div>
    <button class="secondary" style="margin-top:12px;width:100%" onclick="closeProgressList()">å…³é—­</button>
  </div>
</div>

<script>
let all=[],view=[],wrong=new Set();
let i=0,preview=false,inWrong=false,hasProgress=false;
// ====== æ–°å¢ï¼šç”¨æˆ· & é¢˜åº“æ ‡è¯† ======
let userKey = null;
let fileHash = null;
// ====== æ–°å¢ï¼šç”¨æˆ·å ======
let userName = null;
const $=id=>document.getElementById(id);
// ====== ä¸´æ—¶æ—¥å¿—å·¥å…·ï¼ˆBlobs æœªå¯ç”¨æ—¶ç”¨äºå®šä½é—®é¢˜ï¼‰======
// åæœŸå¯æ•´ä½“åˆ é™¤
function log(msg){
  const box = $("debugLog");
  if(!box) return;
  box.style.display = "block";
  const line = document.createElement("div");
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  box.appendChild(line);
  box.scrollTop = box.scrollHeight;
}

// ====== æ–°å¢ï¼šSHA1 å·¥å…· ======
async function sha1(text){
  const buf = new TextEncoder().encode(text);
  const hash = await crypto.subtle.digest("SHA-1", buf);
  return [...new Uint8Array(hash)]
    .map(b=>b.toString(16).padStart(2,"0"))
    .join("");
}

// ====== æ–°å¢ï¼šUI çŠ¶æ€æ˜¾ç¤º ======
function updateUserStatus(){
  if(userKey && userName){
    $("userStatus").textContent = `ğŸ‘¤ ${userName}`;
  }else{
    $("userStatus").textContent = "";
  }
}

function setSyncStatus(text){
  $("syncStatus").textContent = text;
}

// ====== æ–°å¢ï¼šç™»å½•é€»è¾‘ ======
async function doLogin(){
  const name = $("loginName").value.trim();
  const pass = $("loginPass").value.trim();
  if(!name || !pass){
    alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå£ä»¤");
    return;
  }
  userKey = await sha1(name + "::" + pass);
  localStorage.setItem("userKey", userKey);
  userName = name;
  localStorage.setItem("userName", userName);
  $("loginMask").style.display="none";
  updateUserStatus();
  log(`ğŸ‘¤ ç”¨æˆ·ç™»å½•æˆåŠŸï¼š${userName}`);
}

function ensureLogin(){
  userKey = localStorage.getItem("userKey");
  userName = localStorage.getItem("userName");
  if(!userKey){
    $("loginMask").style.display="flex";
  }
  updateUserStatus();
}
// ====== æ–°å¢ï¼šåˆ‡æ¢ç”¨æˆ· ======
function logout(){
  localStorage.removeItem("userKey");
  localStorage.removeItem("userName");
  userKey = null;
  userName = null;
  fileHash = null;
  setSyncStatus("");
  $("userStatus").textContent = "";
  $("loginMask").style.display = "flex";
  log("ğŸ”„ ç”¨æˆ·å·²åˆ‡æ¢ / ç™»å‡º");
}

/* èœå• */
function toggleMenu(e){
  e.stopPropagation();
  $("menuList").classList.toggle("show");
}
document.addEventListener("click",()=>{
  $("menuList").classList.remove("show");
});

/* é¢˜åº“å¯¼å…¥ */
function toggleLoader(){
  $("loader").classList.toggle("hidden");
}
function loadFile(f){
  if(!f.name.endsWith(".txt"))return alert("åªæ”¯æŒ TXT");
  const r=new FileReader();
 r.onload = async ()=>{
  const text = r.result;
  const data = JSON.parse(text);

  fileHash = await sha1(text); // â­ æ–°å¢ï¼šé¢˜åº“å”¯ä¸€ ID

  all = data.items.map((q,idx)=>({...q,_idx:idx}));
  view = all;
  i = 0;
  wrong.clear();
  hasProgress = false;

  $("loader").classList.add("hidden");
  $("fileName").textContent = f.name;

  await loadRemoteProgress(); // â­ æ–°å¢ï¼šæ‹‰å–äº‘ç«¯è¿›åº¦
  render();
};
  r.readAsText(f);
}
fileInput.onchange=e=>loadFile(e.target.files[0]);
loader.ondragover=e=>e.preventDefault();
loader.ondrop=e=>{
  e.preventDefault();
  loadFile(e.dataTransfer.files[0]);
};

/**
 * æ ¸å¿ƒï¼šè§£æé¢˜å¹²ï¼Œè¯†åˆ«ã€å›¾ç‰‡ï¼šé“¾æ¥ã€‘æ ¼å¼å¹¶è½¬æ¢ä¸ºå¯å±•å¼€çš„å›¾ç‰‡å®¹å™¨
 * @param {string} title - åŸå§‹é¢˜å¹²å†…å®¹
 * @returns {string} è§£æåçš„å¸¦å›¾ç‰‡å®¹å™¨çš„é¢˜å¹²HTML
 */
function parseQuestionTitle(title) {
  // æ­£åˆ™åŒ¹é…ã€å›¾ç‰‡ï¼šä»»æ„é“¾æ¥ã€‘æ ¼å¼ï¼Œæ”¯æŒä»»æ„åˆæ³•é“¾æ¥ï¼ˆhttp/https/ç›¸å¯¹è·¯å¾„ç­‰ï¼‰
  const imgReg = /ã€å›¾ç‰‡ï¼š(.*?)ã€‘/g;
  return title.replace(imgReg, (match, imgUrl) => {
    // ç”Ÿæˆå›¾ç‰‡å®¹å™¨ï¼Œå›¾ç‰‡é»˜è®¤éšè—ï¼ŒåŒ…å«åˆ‡æ¢æŒ‰é’®
    return `
      <div class="img-container">
        <button class="img-toggle-btn" onclick="toggleImage(this)">
          ğŸ“· ç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡
        </button>
        <img src="${imgUrl}" class="question-img" hidden alt="é¢˜ç›®å›¾ç‰‡">
      </div>
    `;
  });
}

/**
 * å›¾ç‰‡å±•ç¤º/æ”¶èµ·åˆ‡æ¢å‡½æ•°
 * @param {HTMLElement} btn - ç‚¹å‡»çš„åˆ‡æ¢æŒ‰é’®
 */
function toggleImage(btn) {
  const img = btn.nextElementSibling;
  const isHidden = img.hidden;
  // åˆ‡æ¢å›¾ç‰‡æ˜¾ç¤ºçŠ¶æ€
  img.hidden = !isHidden;
  // åˆ‡æ¢æŒ‰é’®æ–‡å­—
  btn.innerHTML = isHidden ? 'ğŸ“· æ”¶èµ·å›¾ç‰‡' : 'ğŸ“· ç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡';
}

/* æ¸²æŸ“ */
function render(){
  const c=$("content");
  c.innerHTML="";
  if(!view.length){
    c.innerHTML="<div style='color:var(--muted)'>è¯·å…ˆå¯¼å…¥é¢˜åº“</div>";
    return;
  }
  if(preview){
    view.forEach((q,idx)=>{
      // å…¨å±€é¢„è§ˆæ¨¡å¼ä¹Ÿè§£æå›¾ç‰‡
      const parsedTitle = parseQuestionTitle(q.title);
      c.innerHTML+=`
        <div style="margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid var(--border)">
          <b>${idx+1}. ${parsedTitle}</b>
          ${q.options.map(o=>`<div style="margin:4px 0">${o.label}. ${o.text}</div>`).join("")}
          <div style="color:var(--ok); margin-top:8px">ç­”æ¡ˆï¼š${q.correctAnswer[0]}</div>
        </div>`;
    });
    return;
  }
  $("stats").textContent=
    `${inWrong?"é”™é¢˜":"å…¨éƒ¨"} ${i+1}/${view.length}ï½œé”™é¢˜ ${wrong.size}`;
  const percent = Math.round((i+1)/view.length*100);
  setSyncStatus(`ğŸ“Š è¿›åº¦ ${percent}%`);

  // æ™®é€šæ¨¡å¼è§£æé¢˜å¹²å›¾ç‰‡
  const parsedTitle = parseQuestionTitle(view[i].title);
  c.innerHTML=`<div class="question">${parsedTitle}</div>`;
  // ====== ä¸´æ—¶å…œåº•ï¼šé¦–é¢˜å¶å‘ç©ºç™½ï¼ˆå¼‚æ­¥/é¦–å¸§æ—¶åºé—®é¢˜ï¼‰======
  // å¦‚åæœŸç¡®è®¤ä¸å†å‡ºç°ï¼Œå¯å®‰å…¨åˆ é™¤
  if(!parsedTitle || parsedTitle.trim()===""){
    log("âš ï¸ é¦–é¢˜ title å°šæœªå°±ç»ªï¼Œè§¦å‘ä¸€æ¬¡é‡æ¸²æŸ“å…œåº•");
    setTimeout(render, 0);
    return;
  }
  const opt=document.createElement("div");
  opt.className="options";

  view[i].options.forEach(o=>{
    const d=document.createElement("div");
    d.className="option";
    d.textContent=o.label+". "+o.text;
    d.onclick=()=>{
      hasProgress=true;
      document.querySelectorAll(".option")
        .forEach(x=>x.classList.remove("correct","wrong"));
      if(o.text===view[i].correctAnswer[0]){
        d.classList.add("correct");
        if($("autoNext").checked)setTimeout(next,300);
      }else{
        d.classList.add("wrong");
        wrong.add(view[i]._idx);
        saveRemoteProgress();

        // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
        document.querySelectorAll(".option").forEach(opt=>{
          if(opt.textContent.includes(view[i].correctAnswer[0])){
            opt.classList.add("correct");
          }
        });
      }
    };
    opt.appendChild(d);
  });
  c.appendChild(opt);
}

/* æ§åˆ¶ */
function next(){
  if(i<view.length-1){
    i++;
    saveRemoteProgress();
    render();
  }
}
function prev(){
  if(i>0){
    i--;
    saveRemoteProgress();
    render();
  }
}
function toggleWrong(){
  inWrong=!inWrong;
  view=inWrong?[...wrong].map(n=>all[n]):all;
  i=0;render();
}
function togglePreview(){
  preview=!preview;render();
}
// ====== æ–°å¢ï¼šNetlify Blobs åŒæ­¥ ======
async function saveRemoteProgress(){
  if(!userKey || !fileHash) return;
  log("â¡ï¸ å°è¯•ä¿å­˜äº‘ç«¯è¿›åº¦");
  setSyncStatus("â˜ï¸ ä¿å­˜ä¸­...");

  const key = `progress:${userKey}:${fileHash}`;
  try{
    await fetch("/.netlify/functions/progress",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        key,
        data:{
          currentIndex:i,
          wrongIndexes:[...wrong],
          time:Date.now(),
          fileName: $("fileName").textContent,
          total: view.length
        }
      })
    });
    log("âœ… äº‘ç«¯è¿›åº¦ä¿å­˜è¯·æ±‚å·²å‘é€");
    setSyncStatus("â˜ï¸ å·²åŒæ­¥");
  }catch(e){
    log("âŒ äº‘ç«¯ä¿å­˜å¤±è´¥ï¼ˆBlobs å¯èƒ½æœªå¯ç”¨ï¼‰");
    setSyncStatus("âš ï¸ äº‘ç«¯ä¸å¯ç”¨");
  }
}

async function loadRemoteProgress(){
  if(!userKey || !fileHash) return;
  log("â¬‡ï¸ å°è¯•æ‹‰å–äº‘ç«¯è¿›åº¦");
  const key = `progress:${userKey}:${fileHash}`;
  const r = await fetch(`/.netlify/functions/progress?key=${key}`);
  if(!r.ok){
    log("âŒ äº‘ç«¯è¿›åº¦æ¥å£ä¸å¯ç”¨ï¼ˆBlobs / Functions æœªå°±ç»ªï¼‰");
    return;
  }
  const data = await r.json();

  if(data){
    log("âœ… äº‘ç«¯è¿›åº¦å·²æ¢å¤");
    i = data.currentIndex || 0;
    wrong = new Set(data.wrongIndexes || []);
    setSyncStatus("â˜ï¸ å·²æ¢å¤äº‘ç«¯è¿›åº¦");
  }
}
/* å¯¼å‡º / å¯¼å…¥å¤ä¹ åŒ… */
function exportReview(){
  if(!all.length){
    alert("è¯·å…ˆå¯¼å…¥é¢˜åº“");
    return;
  }

  // è·å–å½“å‰åŒ—äº¬æ—¶é—´
  const now = new Date();
  const beijingTime = new Date(now.getTime() + 8*60*60*1000); // UTC+8

  const pad = n => n.toString().padStart(2,'0');
  const timeStr = 
    pad(beijingTime.getMonth()+1) +  // æœˆ
    pad(beijingTime.getDate()) +     // æ—¥
    pad(beijingTime.getHours()) +    // æ—¶
    pad(beijingTime.getMinutes());   // åˆ†

  // é¢˜åº“åç§°å»æ‰æ‰©å±•å
  const fileNameText = $("fileName").textContent.replace(/\.[^.]+$/,'');

  // æ„é€ å¯¼å‡ºæ–‡ä»¶å
  const exportName = `RE${timeStr}_${fileNameText}.txt`;

  // å¯¼å‡ºå†…å®¹
  const data={
    currentIndex:i,
    wrongIndexes:[...wrong],
    time:beijingTime.toLocaleString('zh-CN',{hour12:false})
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"text/plain"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=exportName;
  a.click();
}
function importReview(){
  reviewInput.click();
}
reviewInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f)return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const data=JSON.parse(r.result);
      if(typeof data.currentIndex==="number") i=data.currentIndex;
      if(Array.isArray(data.wrongIndexes))
        data.wrongIndexes.forEach(n=>wrong.add(n));
      render();
      alert("å¤ä¹ è¿›åº¦å·²æ¢å¤");
    }catch{
      alert("å¤ä¹ åŒ…æ ¼å¼é”™è¯¯");
    }
  };
  r.readAsText(f);
};
function jumpToMenu(){
  if(!all.length){
    alert("è¯·å…ˆå¯¼å…¥é¢˜åº“");
    return;
  }
  const val = parseInt(document.getElementById("jumpInputMenu").value);
  if(isNaN(val) || val < 1 || val > view.length){
    alert("è¯·è¾“å…¥æœ‰æ•ˆé¢˜å· (1-"+view.length+")");
    return;
  }
  i = val - 1; // æ•°ç»„ä»0å¼€å§‹
  render();
  // ä¸å…³é—­èœå•ï¼Œè¿™é‡Œä¸è°ƒç”¨ $("menuList").classList.remove("show");
}
// é˜»æ­¢ç‚¹å‡»è¾“å…¥æ¡†æ”¶èµ·èœå•
const inputMenu = document.getElementById("jumpInputMenu");
if(inputMenu){
  inputMenu.addEventListener("click", e => e.stopPropagation());
  inputMenu.addEventListener("mousedown", e => e.stopPropagation());
}

// ====== æ–°å¢ï¼šè¿›åº¦åˆ—è¡¨ ======
async function showProgressList(){
  if(!userKey){
    alert("è¯·å…ˆç™»å½•");
    return;
  }
  $("progressList").innerHTML = "åŠ è½½ä¸­...";
  $("progressMask").style.display = "flex";

  const r = await fetch(`/.netlify/functions/progress?list=1&userKey=${userKey}`);
  const list = await r.json();

  if(!list.length){
    $("progressList").innerHTML = "æš‚æ— è¿›åº¦";
    return;
  }

  $("progressList").innerHTML = list.map(item=>{
    const pct = item.total
      ? Math.round((item.currentIndex+1)/item.total*100)
      : "";
    return `
      <div style="padding:8px 0;border-bottom:1px solid var(--border)">
        <div>ğŸ“„ ${item.fileName || item.fileHash.slice(0,8)}</div>
        <div style="color:var(--muted)">
          è¿›åº¦ï¼š${item.currentIndex+1} / ${item.total || "?"}
          ${pct ? `ï¼ˆ${pct}%ï¼‰` : ""}
        </div>
      </div>
    `;
  }).join("");
}

function closeProgressList(){
  $("progressMask").style.display = "none";
}

/* å¤œé—´ */
darkMode.onchange=e=>{
  document.body.classList.toggle("dark",e.target.checked);
};
(function autoDark(){
  const h=new Date().getHours();
  if(h>=19||h<=6){
    document.body.classList.add("dark");
    $("darkMode").checked=true;
  }
})();

window.addEventListener("beforeunload",e=>{
  if(hasProgress){
    e.preventDefault();e.returnValue="";
  }
});

ensureLogin();
</script>

</body>
<!-- ====== ä¸´æ—¶è°ƒè¯•æ—¥å¿—çª—å£ï¼ˆBlobs / ç™»å½• / åŒæ­¥ï¼‰======
     âš ï¸ ä»…ç”¨äºè°ƒè¯•ï¼ŒåæœŸå¯æ•´ä½“åˆ é™¤ ====== -->
<div id="debugLog" style="
  position:fixed;
  right:10px;
  bottom:10px;
  width:320px;
  max-height:40vh;
  overflow:auto;
  background:rgba(0,0,0,.75);
  color:#e5e7eb;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  z-index:9999;
  display:none;
">
  <div style="font-weight:600;margin-bottom:6px">ğŸªµ è°ƒè¯•æ—¥å¿—</div>
</div>
</html>